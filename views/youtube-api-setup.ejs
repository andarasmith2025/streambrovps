<% layout('layout') -%>

  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold mb-2">YouTube API Configuration</h1>
      <p class="text-gray-400">Setup your own YouTube Data API v3 credentials for unlimited quota</p>
    </div>

    <!-- Status Card -->
    <div class="bg-dark-800 rounded-lg p-6 mb-6 border border-gray-700">
      <div class="flex items-center justify-between">
        <div>
          <h3 class="text-lg font-semibold mb-1">API Status</h3>
          <% if (youtubeConfigured) { %>
            <p class="text-green-400 flex items-center">
              <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              Configured - You can use YouTube features
            </p>
          <% } else { %>
            <p class="text-yellow-400 flex items-center">
              <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
              </svg>
              Not Configured - Setup required to use YouTube features
            </p>
          <% } %>
        </div>
        <% if (youtubeConfigured) { %>
          <button onclick="testConnection()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition">
            Test Connection
          </button>
        <% } %>
      </div>
    </div>

    <!-- Tutorial Accordion -->
    <div class="bg-dark-800 rounded-lg border border-gray-700 mb-6">
      <button onclick="toggleTutorial()" class="w-full px-6 py-4 flex items-center justify-between hover:bg-dark-700 transition">
        <div class="flex items-center">
          <svg class="w-6 h-6 mr-3 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
          </svg>
          <span class="text-lg font-semibold">Step-by-Step Tutorial</span>
        </div>
        <svg id="tutorialIcon" class="w-5 h-5 transform transition-transform" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
        </svg>
      </button>
      
      <div id="tutorialContent" class="hidden px-6 pb-6">
        <div class="space-y-6">
          <!-- Step 1 -->
          <div class="border-l-4 border-blue-500 pl-4">
            <h4 class="font-semibold text-lg mb-2">Step 1: Create Google Cloud Project</h4>
            <ol class="list-decimal list-inside space-y-2 text-gray-300">
              <li>Go to <a href="https://console.cloud.google.com" target="_blank" class="text-blue-400 hover:underline">Google Cloud Console</a></li>
              <li>Click "Select a project" ‚Üí "New Project"</li>
              <li>Enter project name (e.g., "StreamBro YouTube API")</li>
              <li>Click "Create"</li>
            </ol>
            <div class="mt-3 p-3 bg-blue-900/20 rounded border border-blue-700">
              <p class="text-sm text-blue-300">üí° Tip: This is completely FREE. No credit card required.</p>
            </div>
          </div>

          <!-- Step 2 -->
          <div class="border-l-4 border-green-500 pl-4">
            <h4 class="font-semibold text-lg mb-2">Step 2: Enable YouTube Data API v3</h4>
            <ol class="list-decimal list-inside space-y-2 text-gray-300">
              <li>In your project, go to "APIs & Services" ‚Üí "Library"</li>
              <li>Search for "YouTube Data API v3"</li>
              <li>Click on it and press "Enable"</li>
              <li>Wait for activation (usually instant)</li>
            </ol>
          </div>

          <!-- Step 3 -->
          <div class="border-l-4 border-yellow-500 pl-4">
            <h4 class="font-semibold text-lg mb-2">Step 3: Configure OAuth Consent Screen</h4>
            <ol class="list-decimal list-inside space-y-2 text-gray-300">
              <li>Go to "APIs & Services" ‚Üí "OAuth consent screen"</li>
              <li>Select "External" user type ‚Üí Click "Create"</li>
              <li>Fill in:
                <ul class="list-disc list-inside ml-6 mt-2">
                  <li>App name: Your app name</li>
                  <li>User support email: Your email</li>
                  <li>Developer contact: Your email</li>
                </ul>
              </li>
              <li>Click "Save and Continue" through all steps</li>
              <li>Add test users (your YouTube account email)</li>
            </ol>
          </div>

          <!-- Step 4 -->
          <div class="border-l-4 border-purple-500 pl-4">
            <h4 class="font-semibold text-lg mb-2">Step 4: Create OAuth 2.0 Credentials</h4>
            <ol class="list-decimal list-inside space-y-2 text-gray-300">
              <li>Go to "APIs & Services" ‚Üí "Credentials"</li>
              <li>Click "Create Credentials" ‚Üí "OAuth client ID"</li>
              <li>Application type: "Web application"</li>
              <li>Name: "StreamBro Web Client"</li>
              <li>Authorized redirect URIs: Add this URL:
                <div class="mt-2 p-3 bg-dark-700 rounded font-mono text-sm flex items-center justify-between">
                  <code id="redirectUri"><%= redirectUri %></code>
                  <button onclick="copyRedirectUri()" class="ml-2 px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs">
                    Copy
                  </button>
                </div>
              </li>
              <li>Click "Create"</li>
              <li>Copy your Client ID and Client Secret</li>
            </ol>
          </div>

          <!-- Step 5 -->
          <div class="border-l-4 border-red-500 pl-4">
            <h4 class="font-semibold text-lg mb-2">Step 5: Paste Credentials Below</h4>
            <p class="text-gray-300">Copy the Client ID and Client Secret from Google Cloud Console and paste them in the form below.</p>
          </div>
        </div>

        <div class="mt-6 p-4 bg-green-900/20 rounded border border-green-700">
          <h5 class="font-semibold text-green-400 mb-2">‚úÖ What You Get:</h5>
          <ul class="list-disc list-inside space-y-1 text-gray-300">
            <li><strong>10,000 quota units per day</strong> (just for you!)</li>
            <li>Create ~6 live streams per day</li>
            <li>Unlimited stream updates and management</li>
            <li>Schedule YouTube live streams</li>
            <li>Auto-publish to your channel</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Configuration Form -->
    <form id="apiForm" class="bg-dark-800 rounded-lg p-6 border border-gray-700">
      <h3 class="text-xl font-semibold mb-4">API Credentials</h3>
      
      <div class="space-y-4">
        <!-- Client ID -->
        <div>
          <label class="block text-sm font-medium mb-2">
            Client ID
            <span class="text-red-400">*</span>
          </label>
          <input 
            type="text" 
            id="clientId" 
            name="client_id"
            value="<%= credentials.youtube_client_id || '' %>"
            placeholder="123456789-abcdefghijklmnop.apps.googleusercontent.com"
            class="w-full px-4 py-2 bg-dark-700 border border-gray-600 rounded-lg focus:outline-none focus:border-blue-500"
            required
          >
          <p class="text-xs text-gray-400 mt-1">From Google Cloud Console ‚Üí Credentials</p>
        </div>

        <!-- Client Secret -->
        <div>
          <label class="block text-sm font-medium mb-2">
            Client Secret
            <span class="text-red-400">*</span>
          </label>
          <input 
            type="password" 
            id="clientSecret" 
            name="client_secret"
            value="<%= credentials.youtube_client_secret || '' %>"
            placeholder="GOCSPX-xxxxxxxxxxxxxxxxxxxxx"
            class="w-full px-4 py-2 bg-dark-700 border border-gray-600 rounded-lg focus:outline-none focus:border-blue-500"
            required
          >
          <button type="button" onclick="toggleSecret()" class="text-xs text-blue-400 hover:underline mt-1">
            Show/Hide
          </button>
        </div>

        <!-- Redirect URI (Auto-filled) -->
        <div>
          <label class="block text-sm font-medium mb-2">
            Redirect URI
            <span class="text-gray-400 text-xs">(Auto-configured)</span>
          </label>
          <input 
            type="text" 
            id="redirectUriInput" 
            name="redirect_uri"
            value="<%= redirectUri %>"
            readonly
            class="w-full px-4 py-2 bg-dark-700 border border-gray-600 rounded-lg text-gray-400 cursor-not-allowed"
          >
          <p class="text-xs text-gray-400 mt-1">This must match the URI in Google Cloud Console</p>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex gap-3 mt-6">
        <button 
          type="submit" 
          class="flex-1 px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition"
        >
          Save Configuration
        </button>
        <% if (youtubeConfigured) { %>
          <button 
            type="button" 
            onclick="clearCredentials()"
            class="px-6 py-3 bg-red-600 hover:bg-red-700 rounded-lg font-semibold transition"
          >
            Clear
          </button>
        <% } %>
      </div>
    </form>

    <!-- Help Section -->
    <div class="mt-6 p-4 bg-yellow-900/20 rounded border border-yellow-700">
      <h4 class="font-semibold text-yellow-400 mb-2">Need Help?</h4>
      <p class="text-gray-300 text-sm">
        If you encounter any issues during setup, please check:
      </p>
      <ul class="list-disc list-inside text-gray-300 text-sm mt-2 space-y-1">
        <li>Make sure the Redirect URI matches exactly (including https://)</li>
        <li>Add your YouTube account email as a test user in OAuth consent screen</li>
        <li>Wait a few minutes after enabling the API</li>
        <li>Check that your Google Cloud project is selected</li>
      </ul>
    </div>
  </div>

  <script>
    function toggleTutorial() {
      const content = document.getElementById('tutorialContent');
      const icon = document.getElementById('tutorialIcon');
      content.classList.toggle('hidden');
      icon.classList.toggle('rotate-180');
    }

    function toggleSecret() {
      const input = document.getElementById('clientSecret');
      input.type = input.type === 'password' ? 'text' : 'password';
    }

    function copyRedirectUri() {
      const uri = document.getElementById('redirectUri').textContent;
      navigator.clipboard.writeText(uri).then(() => {
        alert('Redirect URI copied to clipboard!');
      });
    }

    document.getElementById('apiForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      
      try {
        const response = await fetch('/api/youtube/credentials', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('‚úÖ YouTube API credentials saved successfully!');
          window.location.reload();
        } else {
          alert('‚ùå Error: ' + (result.error || 'Failed to save credentials'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error saving credentials. Please try again.');
      }
    });

    function clearCredentials() {
      if (confirm('Are you sure you want to clear your YouTube API credentials?')) {
        fetch('/api/youtube/credentials', {
          method: 'DELETE'
        })
        .then(res => res.json())
        .then(result => {
          if (result.success) {
            alert('‚úÖ Credentials cleared successfully');
            window.location.reload();
          } else {
            alert('‚ùå Error clearing credentials');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('‚ùå Error clearing credentials');
        });
      }
    }

    async function testConnection() {
      try {
        const response = await fetch('/api/youtube/test-connection');
        const result = await response.json();
        
        if (result.success) {
          alert('‚úÖ Connection successful!\n\nQuota remaining: ' + result.quotaRemaining + ' units');
        } else {
          alert('‚ùå Connection failed: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error testing connection');
      }
    }
  </script>
