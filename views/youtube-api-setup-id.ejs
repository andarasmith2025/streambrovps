<% layout('layout') -%>

  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold mb-2">Konfigurasi YouTube API</h1>
      <p class="text-gray-400">Setup kredensial YouTube Data API v3 Anda sendiri untuk quota unlimited</p>
    </div>

    <!-- Status Card -->
    <div class="bg-dark-800 rounded-lg p-6 mb-6 border border-gray-700">
      <div class="flex items-center justify-between">
        <div>
          <h3 class="text-lg font-semibold mb-1">Status API</h3>
          <% if (youtubeConfigured) { %>
            <p class="text-green-400 flex items-center">
              <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              Sudah Dikonfigurasi - Anda dapat menggunakan fitur YouTube
            </p>
          <% } else { %>
            <p class="text-yellow-400 flex items-center">
              <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
              </svg>
              Belum Dikonfigurasi - Setup diperlukan untuk menggunakan fitur YouTube
            </p>
          <% } %>
        </div>
        <% if (youtubeConfigured) { %>
          <button onclick="testConnection()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition">
            Tes Koneksi
          </button>
        <% } %>
      </div>
    </div>

    <!-- Tutorial Accordion -->
    <div class="bg-dark-800 rounded-lg border border-gray-700 mb-6">
      <button onclick="toggleTutorial()" class="w-full px-6 py-4 flex items-center justify-between hover:bg-dark-700 transition">
        <div class="flex items-center">
          <svg class="w-6 h-6 mr-3 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
          </svg>
          <span class="text-lg font-semibold">Panduan Langkah demi Langkah</span>
        </div>
        <svg id="tutorialIcon" class="w-5 h-5 transform transition-transform" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
        </svg>
      </button>
      
      <div id="tutorialContent" class="hidden px-6 pb-6">
        <!-- Video Tutorial -->
        <div class="mb-6 p-4 bg-gradient-to-r from-red-900/20 to-blue-900/20 rounded-lg border border-red-700/50">
          <div class="flex items-start gap-3">
            <svg class="w-8 h-8 text-red-500 flex-shrink-0 mt-1" fill="currentColor" viewBox="0 0 20 20">
              <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"/>
            </svg>
            <div class="flex-1">
              <h3 class="text-lg font-semibold text-white mb-2">üìπ Video Tutorial</h3>
              <p class="text-gray-300 text-sm mb-3">Tonton video tutorial lengkap cara setup OAuth 2.0 untuk YouTube API (step-by-step dengan visual):</p>
              <a href="https://drive.google.com/file/d/1l9zKFguYqqAAlywmssnasCcdJlvqjc9h/view?usp=sharing" 
                 target="_blank" 
                 class="inline-flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/>
                </svg>
                Tonton Video Tutorial
              </a>
            </div>
          </div>
        </div>

        <div class="space-y-6">
          <!-- Step 1 -->
          <div class="border-l-4 border-blue-500 pl-4">
            <h4 class="font-semibold text-lg mb-2">Langkah 1: Buat Google Cloud Project</h4>
            <ol class="list-decimal list-inside space-y-2 text-gray-300">
              <li>Buka <a href="https://console.cloud.google.com" target="_blank" class="text-blue-400 hover:underline">Google Cloud Console</a></li>
              <li><strong>Klik dropdown project:</strong> Di bagian atas (sebelah logo Google Cloud), klik tulisan "Select a project" atau nama project yang sedang aktif</li>
              <li><strong>Buat project baru:</strong> Di popup yang muncul, klik tombol <strong>"NEW PROJECT"</strong> di pojok kanan atas</li>
              <li>Masukkan nama project (contoh: "StreamBro YouTube API")</li>
              <li>Klik tombol <strong>"Create"</strong></li>
              <li>Tunggu beberapa detik sampai project dibuat (akan ada notifikasi)</li>
              <li><strong>Pilih project:</strong> Klik dropdown project lagi dan pilih project yang baru Anda buat</li>
            </ol>
            <div class="mt-3 p-3 bg-blue-900/20 rounded border border-blue-700">
              <p class="text-sm text-blue-300">üí° Tips: Ini 100% GRATIS. Tidak perlu kartu kredit. Pastikan project yang baru dibuat sudah terpilih (terlihat di bagian atas) sebelum lanjut ke langkah berikutnya.</p>
            </div>
          </div>

          <!-- Step 2 -->
          <div class="border-l-4 border-green-500 pl-4">
            <h4 class="font-semibold text-lg mb-2">Langkah 2: Aktifkan YouTube Data API v3</h4>
            <ol class="list-decimal list-inside space-y-2 text-gray-300">
              <li>Di project Anda, buka "APIs & Services" ‚Üí "Library"</li>
              <li>Cari "YouTube Data API v3"</li>
              <li>Klik dan tekan "Enable"</li>
              <li>Tunggu aktivasi (biasanya instant)</li>
            </ol>
          </div>

          <!-- Step 3 -->
          <div class="border-l-4 border-yellow-500 pl-4">
            <h4 class="font-semibold text-lg mb-2">Langkah 3: Konfigurasi OAuth Consent Screen</h4>
            <ol class="list-decimal list-inside space-y-2 text-gray-300">
              <li><strong>Buka menu:</strong> Di sidebar kiri, klik "APIs & Services" ‚Üí pilih "OAuth consent screen"</li>
              <li><strong>Pilih User Type:</strong> Anda akan melihat halaman dengan 2 pilihan:
                <ul class="list-disc list-inside ml-6 mt-2 space-y-1">
                  <li><strong>Internal</strong> - Hanya untuk organisasi Google Workspace (skip ini)</li>
                  <li><strong>External</strong> - Untuk semua pengguna (pilih ini ‚úì)</li>
                </ul>
              </li>
              <li>Klik tombol radio <strong>"External"</strong></li>
              <li>Klik tombol <strong>"Create"</strong> di bawah</li>
              <li><strong>Isi form App Information:</strong>
                <ul class="list-disc list-inside ml-6 mt-2">
                  <li>App name: Nama aplikasi Anda (contoh: "StreamBro")</li>
                  <li>User support email: Pilih email Anda dari dropdown</li>
                  <li>Developer contact: Masukkan email Anda</li>
                </ul>
              </li>
              <li>Klik <strong>"Save and Continue"</strong> sampai halaman "Test users"</li>
              <li><strong>Tambahkan test users:</strong> Klik "Add Users" dan masukkan email akun YouTube Anda</li>
              <li>Klik "Save and Continue" sampai selesai</li>
            </ol>
            <div class="mt-3 p-3 bg-yellow-900/20 rounded border border-yellow-700">
              <p class="text-sm text-yellow-300">‚ö†Ô∏è Penting: Pilih "External" bukan "Internal". Jika tidak melihat pilihan ini, pastikan Anda sudah di halaman "OAuth consent screen".</p>
            </div>
          </div>

          <!-- Step 4 -->
          <div class="border-l-4 border-purple-500 pl-4">
            <h4 class="font-semibold text-lg mb-2">Langkah 4: Buat OAuth 2.0 Credentials</h4>
            <ol class="list-decimal list-inside space-y-2 text-gray-300">
              <li>Buka "APIs & Services" ‚Üí "Credentials"</li>
              <li>Klik "Create Credentials" ‚Üí "OAuth client ID"</li>
              <li>Application type: "Web application"</li>
              <li>Name: "StreamBro Web Client"</li>
              <li>Authorized redirect URIs: Tambahkan URL ini:
                <div class="mt-2 p-3 bg-dark-700 rounded font-mono text-sm flex items-center justify-between">
                  <code id="redirectUri"><%= redirectUri %></code>
                  <button onclick="copyRedirectUri()" class="ml-2 px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs">
                    Salin
                  </button>
                </div>
              </li>
              <li>Klik "Create"</li>
              <li>Salin Client ID dan Client Secret Anda</li>
            </ol>
          </div>

          <!-- Step 5 -->
          <div class="border-l-4 border-red-500 pl-4">
            <h4 class="font-semibold text-lg mb-2">Langkah 5: Paste Credentials di Bawah</h4>
            <p class="text-gray-300">Salin Client ID dan Client Secret dari Google Cloud Console dan paste di form di bawah ini.</p>
          </div>
        </div>

        <div class="mt-6 p-4 bg-green-900/20 rounded border border-green-700">
          <h5 class="font-semibold text-green-400 mb-2">‚úÖ Yang Anda Dapatkan:</h5>
          <ul class="list-disc list-inside space-y-1 text-gray-300">
            <li><strong>10,000 quota units per hari</strong> (khusus untuk Anda!)</li>
            <li>Buat ~6 live stream per hari</li>
            <li>Update dan kelola stream tanpa batas</li>
            <li>Jadwalkan YouTube live stream</li>
            <li>Auto-publish ke channel Anda</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Configuration Form -->
    <form id="apiForm" class="bg-dark-800 rounded-lg p-6 border border-gray-700">
      <h3 class="text-xl font-semibold mb-4">Kredensial API</h3>
      
      <div class="space-y-4">
        <!-- Client ID -->
        <div>
          <label class="block text-sm font-medium mb-2">
            Client ID
            <span class="text-red-400">*</span>
          </label>
          <input 
            type="text" 
            id="clientId" 
            name="client_id"
            value="<%= credentials.youtube_client_id || '' %>"
            placeholder="123456789-abcdefghijklmnop.apps.googleusercontent.com"
            class="w-full px-4 py-2 bg-dark-700 border border-gray-600 rounded-lg focus:outline-none focus:border-blue-500"
            required
          >
          <p class="text-xs text-gray-400 mt-1">Dari Google Cloud Console ‚Üí Credentials</p>
        </div>

        <!-- Client Secret -->
        <div>
          <label class="block text-sm font-medium mb-2">
            Client Secret
            <span class="text-red-400">*</span>
          </label>
          <input 
            type="password" 
            id="clientSecret" 
            name="client_secret"
            value="<%= credentials.youtube_client_secret || '' %>"
            placeholder="GOCSPX-xxxxxxxxxxxxxxxxxxxxx"
            class="w-full px-4 py-2 bg-dark-700 border border-gray-600 rounded-lg focus:outline-none focus:border-blue-500"
            required
          >
          <button type="button" onclick="toggleSecret()" class="text-xs text-blue-400 hover:underline mt-1">
            Tampilkan/Sembunyikan
          </button>
        </div>

        <!-- Redirect URI (Auto-filled) -->
        <div>
          <label class="block text-sm font-medium mb-2">
            Redirect URI
            <span class="text-gray-400 text-xs">(Otomatis terisi)</span>
          </label>
          <input 
            type="text" 
            id="redirectUriInput" 
            name="redirect_uri"
            value="<%= redirectUri %>"
            readonly
            class="w-full px-4 py-2 bg-dark-700 border border-gray-600 rounded-lg text-gray-400 cursor-not-allowed"
          >
          <p class="text-xs text-gray-400 mt-1">Harus sama dengan URI di Google Cloud Console</p>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex gap-3 mt-6">
        <button 
          type="submit" 
          class="flex-1 px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition"
        >
          Simpan Konfigurasi
        </button>
        <% if (youtubeConfigured) { %>
          <button 
            type="button" 
            onclick="clearCredentials()"
            class="px-6 py-3 bg-red-600 hover:bg-red-700 rounded-lg font-semibold transition"
          >
            Hapus
          </button>
        <% } %>
      </div>
    </form>

    <!-- Help Section -->
    <div class="mt-6 p-4 bg-yellow-900/20 rounded border border-yellow-700">
      <h4 class="font-semibold text-yellow-400 mb-2">Butuh Bantuan?</h4>
      <p class="text-gray-300 text-sm">
        Jika mengalami masalah saat setup, pastikan:
      </p>
      <ul class="list-disc list-inside text-gray-300 text-sm mt-2 space-y-1">
        <li>Redirect URI sama persis (termasuk https://)</li>
        <li>Email akun YouTube Anda sudah ditambahkan sebagai test user</li>
        <li>Tunggu beberapa menit setelah enable API</li>
        <li>Pastikan Google Cloud project sudah dipilih</li>
      </ul>
    </div>
  </div>

  <script>
    function toggleTutorial() {
      const content = document.getElementById('tutorialContent');
      const icon = document.getElementById('tutorialIcon');
      content.classList.toggle('hidden');
      icon.classList.toggle('rotate-180');
    }

    function toggleSecret() {
      const input = document.getElementById('clientSecret');
      input.type = input.type === 'password' ? 'text' : 'password';
    }

    function copyRedirectUri() {
      const uri = document.getElementById('redirectUri').textContent;
      navigator.clipboard.writeText(uri).then(() => {
        alert('Redirect URI berhasil disalin!');
      });
    }

    document.getElementById('apiForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      
      try {
        const response = await fetch('/api/youtube/credentials', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('‚úÖ Kredensial YouTube API berhasil disimpan!');
          window.location.reload();
        } else {
          alert('‚ùå Error: ' + (result.error || 'Gagal menyimpan kredensial'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error menyimpan kredensial. Silakan coba lagi.');
      }
    });

    function clearCredentials() {
      if (confirm('Apakah Anda yakin ingin menghapus kredensial YouTube API Anda?')) {
        fetch('/api/youtube/credentials', {
          method: 'DELETE'
        })
        .then(res => res.json())
        .then(result => {
          if (result.success) {
            alert('‚úÖ Kredensial berhasil dihapus');
            window.location.reload();
          } else {
            alert('‚ùå Error menghapus kredensial');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('‚ùå Error menghapus kredensial');
        });
      }
    }

    async function testConnection() {
      try {
        const response = await fetch('/api/youtube/test-connection');
        const result = await response.json();
        
        if (result.success) {
          alert('‚úÖ Koneksi berhasil!\n\nQuota tersisa: ' + result.quotaRemaining + ' units');
        } else {
          alert('‚ùå Koneksi gagal: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error testing connection');
      }
    }
  </script>
