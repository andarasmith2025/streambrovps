<!-- Edit Stream Modal -->
<div id="editStreamModal" class="fixed inset-0 bg-black/50 z-50 hidden modal-overlay flex items-center justify-center p-2 md:p-4">
  <div class="bg-dark-800 rounded-lg shadow-xl w-full max-w-2xl modal-container max-h-[95vh] md:max-h-[92vh] flex flex-col relative">
    
    <!-- Header -->
    <%- include('stream-modal-header', {
      title: 'Edit Stream',
      showSaveTemplate: true,
      saveTemplateFunction: 'saveEditAsTemplate',
      showImport: false,
      closeFunction: 'closeEditStreamModal'
    }) %>
    
    <!-- Tabs -->
    <%- include('stream-modal-tabs', {
      tabPrefix: 'editTab'
    }) %>
    
    <!-- Form Content -->
    <div class="flex-1 overflow-y-auto">
      <form id="editStreamForm" class="px-4 pt-3 pb-3 space-y-3" novalidate>
        <input type="hidden" id="editStreamId" name="streamId" value="">
        <input type="hidden" id="editSelectedVideoId" name="videoId" value="">
        
        <div class="space-y-3">
          <!-- Video Selector -->
          <%- include('stream-modal-video-selector', {
            videoIdField: 'editSelectedVideoId',
            selectedVideoField: 'editSelectedVideo',
            dropdownId: 'editVideoSelectorDropdown',
            searchInputId: 'editVideoSearchInput',
            listContainerId: 'editVideoListContainer'
          }) %>
          
          <!-- Stream Title with Autocomplete and AI Generate -->
          <div>
            <div class="flex items-center justify-between mb-2">
              <label class="text-sm font-medium text-white">Stream Title</label>
              <button
                type="button"
                onclick="generateTitleWithGemini('editStreamTitle')"
                class="flex items-center gap-1 px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white rounded text-xs transition-colors"
                title="Generate SEO-optimized title from keywords"
              >
                <i class="ti ti-sparkles text-sm"></i>
                <span>Generate Title</span>
              </button>
            </div>
            <div class="relative">
              <input type="text" id="editStreamTitle" name="streamTitle" required
                class="w-full px-4 py-2.5 bg-dark-700 border border-gray-600 rounded-lg focus:border-primary focus:ring-1 focus:ring-primary"
                placeholder="Enter stream title (suggestions will appear as you type)">
              
              <!-- Autocomplete Dropdown -->
              <div id="editTitleSuggestionsDropdown" class="hidden absolute z-20 w-full mt-1 bg-dark-700 border border-gray-600 rounded-lg shadow-lg max-h-64 overflow-y-auto">
                <!-- Suggestions will be populated here -->
              </div>
            </div>
          </div>
          
          <!-- YouTube API Fields (Edit version with unique IDs) -->
          <div id="editYoutubeApiFields" class="hidden space-y-3">
            
            <!-- Description with AI Generate Button -->
            <div>
              <div class="flex items-center justify-between mb-2">
                <label class="text-sm font-medium text-white">Description</label>
                <button
                  type="button"
                  onclick="generateEditDescriptionWithGemini()"
                  class="flex items-center gap-1 px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white rounded text-xs transition-colors"
                  title="Generate SEO-optimized description from title"
                >
                  <i class="ti ti-sparkles text-sm"></i>
                  <span>Generate Description</span>
                </button>
              </div>
              <textarea name="youtubeDescription" id="editYoutubeDescription" rows="3"
                class="w-full px-4 py-2.5 bg-dark-700 border border-gray-600 rounded-lg focus:border-primary focus:ring-1 focus:ring-primary"
                placeholder="Stream description (optional - or generate with AI)"></textarea>
            </div>
            
            <!-- Tags Input with Gemini AI -->
            <div>
              <div class="flex items-center justify-between mb-2">
                <label class="text-sm font-medium text-white">
                  Tags
                  <span class="text-gray-500 text-xs ml-2">(Optional - improves discoverability)</span>
                </label>
                <button
                  type="button"
                  onclick="generateEditTagsWithGemini()"
                  class="flex items-center gap-1 px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white rounded text-xs transition-colors"
                >
                  <i class="ti ti-sparkles text-sm"></i>
                  <span>Generate with AI</span>
                </button>
              </div>
              
              <!-- Tags Container -->
              <div id="editTagsContainer" class="flex flex-wrap gap-2 p-3 bg-dark-700 border border-gray-600 rounded-lg min-h-[60px]">
                <span class="text-gray-500 text-sm">No tags added yet. Click "Generate with AI" or add manually.</span>
              </div>
              
              <!-- Tag Input -->
              <div class="mt-2 flex gap-2">
                <input
                  type="text"
                  id="editTagInput"
                  placeholder="Type a tag and press Enter"
                  class="flex-1 px-3 py-2 bg-dark-700 border border-gray-600 rounded-lg focus:border-primary focus:ring-1 focus:ring-primary text-sm"
                  onkeypress="handleEditTagInput(event)"
                  maxlength="30"
                />
                <button
                  type="button"
                  onclick="addEditTag()"
                  class="px-4 py-2 bg-primary hover:bg-blue-600 text-white rounded-lg transition-colors text-sm"
                >
                  Add
                </button>
              </div>
              
              <!-- Tag Stats -->
              <div class="mt-2 flex items-center justify-between text-xs">
                <span id="editTagCount" class="text-gray-500">0 / 30 tags</span>
                <span id="editTagLength" class="text-gray-500">0 / 500 characters</span>
              </div>
              
              <!-- Hidden input for form submission -->
              <input type="hidden" id="editYoutubeTags" name="youtubeTags" value="[]" />
            </div>
            
            <!-- Stream Configuration -->
            <label class="text-sm font-medium text-white block mb-1.5">Stream Configuration</label>
            <div class="space-y-2">
              <div class="relative">
                <input type="text" id="editYoutubeRtmpUrl"
                  class="w-full pl-10 pr-12 py-2.5 bg-dark-700 border border-gray-600 rounded-lg focus:border-primary focus:ring-1 focus:ring-primary"
                  placeholder="RTMP URL">
                <i class="ti ti-link absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <button type="button" id="editYoutubePlatformSelector"
                  class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 flex items-center justify-center rounded-full hover:bg-dark-600 transition-colors"
                  aria-label="Select platform">
                  <i class="ti ti-list-check text-gray-400 hover:text-primary"></i>
                </button>
                <div id="editYoutubePlatformDropdown"
                  class="hidden absolute z-10 right-0 mt-1 w-48 bg-dark-700 rounded-lg border border-gray-600 shadow-lg overflow-hidden">
                  <div class="py-1">
                    <button type="button" class="youtube-platform-option w-full flex items-center px-4 py-2 hover:bg-dark-600" data-url="rtmps://a.rtmp.youtube.com/live2">
                      <i class="ti ti-brand-youtube text-red-500 text-base mr-2"></i>
                      <span class="text-sm">YouTube</span>
                    </button>
                    <button type="button" class="youtube-platform-option w-full flex items-center px-4 py-2 hover:bg-dark-600" data-url="rtmps://b.rtmp.youtube.com/live2?backup=1">
                      <i class="ti ti-brand-youtube text-red-400 text-base mr-2"></i>
                      <span class="text-sm">YouTube (Backup)</span>
                    </button>
                    <button type="button" class="youtube-platform-option w-full flex items-center px-4 py-2 hover:bg-dark-600" data-url="rtmps://live-api-s.facebook.com:443/rtmp">
                      <i class="ti ti-brand-facebook text-blue-500 text-base mr-2"></i>
                      <span class="text-sm">Facebook</span>
                    </button>
                    <button type="button" class="youtube-platform-option w-full flex items-center px-4 py-2 hover:bg-dark-600" data-url="rtmps://ingest.global.live.prod.tiktok.com/live">
                      <i class="ti ti-brand-tiktok text-black text-base mr-2"></i>
                      <span class="text-sm">TikTok</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Stream Key with Load Button -->
            <div>
              <label class="text-sm font-medium text-white block mb-2">Stream Key</label>
              <div class="flex gap-2">
                <div class="relative flex-1">
                  <input type="password" id="editYoutubeStreamKey"
                    class="w-full px-4 py-2.5 pl-10 pr-12 bg-dark-700 border border-gray-600 rounded-lg focus:border-primary focus:ring-1 focus:ring-primary font-mono text-sm"
                    placeholder="Enter stream key or load from channel">
                  <input type="hidden" id="editYoutubeStreamId" value="">
                  <i class="ti ti-key text-gray-500 absolute left-3 top-1/2 -translate-y-1/2"></i>
                  <button type="button" onclick="toggleEditYouTubeStreamKeyVisibility()"
                    class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white transition-colors">
                    <i class="ti ti-eye" id="editYoutubeStreamKeyToggle"></i>
                  </button>
                </div>
                <button type="button" onclick="toggleEditYouTubeStreamKeysDropdown()"
                  class="flex items-center gap-2 px-4 py-2.5 bg-primary hover:bg-blue-600 text-white rounded-lg transition-colors whitespace-nowrap">
                  <i class="ti ti-download text-sm"></i>
                  <span>Load</span>
                </button>
              </div>
              
              <!-- Dropdown for Stream Keys -->
              <div id="editYoutubeStreamKeysDropdown" class="hidden mt-2 bg-dark-700 border border-gray-600 rounded-lg shadow-lg">
                <div class="p-2">
                  <div class="flex items-center justify-between mb-2 px-2 pb-2 border-b border-gray-600">
                    <div class="flex items-center gap-2">
                      <span class="text-xs font-medium text-gray-300">Stream Keys</span>
                      <span id="editStreamKeysCount" class="text-xs text-gray-500"></span>
                    </div>
                    <div class="flex items-center gap-2">
                      <span id="editStreamKeysCacheInfo" class="text-xs text-gray-500"></span>
                      <button type="button" onclick="refreshEditYouTubeStreamKeys()"
                        class="p-1 text-gray-400 hover:text-primary transition-colors rounded hover:bg-gray-600" 
                        title="Refresh stream keys">
                        <i class="ti ti-refresh text-sm"></i>
                      </button>
                      <button type="button" onclick="toggleEditYouTubeStreamKeysDropdown()"
                        class="p-1 text-gray-400 hover:text-white transition-colors rounded hover:bg-gray-600"
                        title="Close">
                        <i class="ti ti-x text-sm"></i>
                      </button>
                    </div>
                  </div>
                  <div class="max-h-64 overflow-y-auto">
                    <div id="editYoutubeStreamKeysList" class="space-y-1">
                      <div class="text-center py-4 text-gray-400">
                        <i class="ti ti-loader animate-spin text-xl mb-2"></i>
                        <p class="text-xs">Loading stream keys...</p>
                      </div>
                    </div>
                  </div>
                  <div class="mt-2 pt-2 border-t border-gray-600 px-2">
                    <div class="flex items-center gap-3 text-xs text-gray-500">
                      <span class="flex items-center gap-1"><i class="ti ti-link text-blue-400"></i> RTMP</span>
                      <span class="flex items-center gap-1"><i class="ti ti-key text-yellow-400"></i> Key</span>
                      <span class="flex items-center gap-1"><i class="ti ti-copy text-green-400"></i> Copy All</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Additional Settings (Collapsible) -->
            <div class="border-t border-gray-700 pt-3">
              <button type="button" onclick="toggleEditYouTubeAdditionalSettings()"
                class="flex items-center justify-between w-full px-2 py-2 hover:bg-dark-700/30 rounded transition-colors">
                <span class="text-sm font-medium text-white">
                  <i class="ti ti-settings mr-1.5"></i>Additional Settings (Optional)
                </span>
                <i class="ti ti-chevron-down text-gray-400 transition-transform duration-200" id="editYoutubeAdditionalSettingsIcon"></i>
              </button>
              
              <div id="editYoutubeAdditionalSettings" class="hidden mt-3 space-y-3">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <!-- Privacy -->
                  <div>
                    <label class="text-sm font-medium text-white block mb-2">Privacy</label>
                    <select name="youtubePrivacy" id="editYoutubePrivacy"
                      class="w-full px-4 py-2.5 bg-dark-700 border border-gray-600 rounded-lg focus:border-primary focus:ring-1 focus:ring-primary text-sm">
                      <option value="public">Public</option>
                      <option value="unlisted" selected>Unlisted</option>
                      <option value="private">Private</option>
                    </select>
                  </div>
                  
                  <!-- Thumbnail -->
                  <div>
                    <label class="text-sm font-medium text-white block mb-2">Thumbnail (16:9 ratio recommended)</label>
                    <input type="file" name="youtubeThumbnail" id="editYoutubeThumbnail" accept="image/*" onchange="previewEditYoutubeThumbnail(this)"
                      class="w-full px-4 py-2.5 bg-dark-700 border border-gray-600 rounded-lg focus:border-primary file:mr-4 file:py-2 file:px-4 file:border-0 file:text-sm file:bg-dark-600 file:text-gray-200 file:rounded text-sm cursor-pointer hover:border-primary transition-colors">
                    <p id="editYoutubeThumbnailInfo" class="text-xs text-gray-400 mt-1"></p>
                    
                    <!-- Thumbnail Preview (below file input) -->
                    <div id="editYoutubeThumbnailPreview" class="hidden mt-3">
                      <div class="relative inline-block">
                        <img id="editYoutubeThumbnailImg" src="" alt="Thumbnail preview" class="w-32 h-18 object-cover rounded border border-gray-600">
                        <button type="button" onclick="clearEditYoutubeThumbnail()" class="absolute -top-2 -right-2 w-5 h-5 bg-red-500 hover:bg-red-600 rounded-full flex items-center justify-center text-white text-xs shadow-lg">
                          <i class="ti ti-x text-xs"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <!-- Made for Kids -->
                  <div>
                    <label class="text-sm font-medium text-white block mb-2">Made for Kids</label>
                    <div class="flex items-center gap-4 pt-2">
                      <label class="flex items-center gap-2 text-sm text-gray-300 cursor-pointer">
                        <input type="radio" name="editYoutubeMadeForKids" value="yes" class="w-4 h-4">
                        <span>Yes</span>
                      </label>
                      <label class="flex items-center gap-2 text-sm text-gray-300 cursor-pointer">
                        <input type="radio" name="editYoutubeMadeForKids" value="no" checked class="w-4 h-4">
                        <span>No</span>
                      </label>
                    </div>
                  </div>
                  
                  <!-- Age Restriction -->
                  <div>
                    <label class="text-sm font-medium text-white block mb-2">Age Restriction</label>
                    <label class="flex items-center gap-2 text-sm text-gray-300 cursor-pointer pt-2">
                      <input type="checkbox" name="youtubeAgeRestricted" id="editYoutubeAgeRestricted" class="w-4 h-4 rounded">
                      <span>Age-restricted (18+)</span>
                    </label>
                  </div>
                  
                  <!-- Konten Sintetis -->
                  <div>
                    <label class="text-sm font-medium text-white block mb-2">Konten Sintetis</label>
                    <label class="flex items-center gap-2 text-sm text-gray-300 cursor-pointer pt-2">
                      <input type="checkbox" name="youtubeSyntheticContent" id="editYoutubeSyntheticContent" class="w-4 h-4 rounded">
                      <span>Konten dibuat atau dimodifikasi dengan AI</span>
                    </label>
                    <p class="text-xs text-gray-500 mt-1">Centang jika video ini menggunakan teknologi AI untuk pembuatan atau modifikasi konten</p>
                  </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <!-- Auto Start -->
                  <div>
                    <label class="flex items-center gap-2 text-sm text-gray-300 cursor-pointer">
                      <input type="checkbox" name="youtubeAutoStart" id="editYoutubeAutoStart" class="w-4 h-4 rounded">
                      <span>Auto Start Broadcast (via API)</span>
                    </label>
                    <p class="text-xs text-gray-500 mt-1 ml-6">Automatically transition broadcast to "live" when stream starts</p>
                  </div>
                  
                  <!-- Auto End -->
                  <div>
                    <label class="flex items-center gap-2 text-sm text-gray-300 cursor-pointer">
                      <input type="checkbox" name="youtubeAutoEnd" id="editYoutubeAutoEnd" class="w-4 h-4 rounded">
                      <span>Auto End Broadcast (via API)</span>
                    </label>
                    <p class="text-xs text-gray-500 mt-1 ml-6">Automatically complete broadcast when stream ends</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Manual RTMP Fields -->
          <%- include('stream-modal-manual-rtmp', {
            rtmpUrlId: 'editRtmpUrl',
            streamKeyId: 'editStreamKey',
            platformSelectorId: 'editPlatformSelector',
            platformDropdownId: 'editPlatformDropdown',
            streamKeyToggleId: 'editStreamKeyToggle',
            streamKeysDropdownId: 'editManualRTMPStreamKeysDropdown',
            streamKeysListId: 'editManualRTMPStreamKeysList',
            streamKeysCountId: 'editManualStreamKeysCount',
            streamKeysCacheInfoId: 'editManualStreamKeysCacheInfo'
          }) %>
          
          <!-- Schedule Settings -->
          <%- include('stream-modal-schedule', {
            scheduleSlotsContainerId: 'editScheduleSlotsContainer',
            loopVideoId: 'editLoopVideo',
            addSlotFunction: 'addEditScheduleSlot',
            serverTimeDisplayId: 'editServerTimeDisplay'
          }) %>
        </div>
      </form>
    </div>
    
    <!-- Footer -->
    <%- include('stream-modal-footer', {
      formId: 'editStreamForm',
      cancelFunction: 'closeEditStreamModal',
      submitButtonText: 'Update Stream'
    }) %>
  </div>
</div>
